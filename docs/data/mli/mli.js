// ==========================================
// MLI Marketing Dashboard Data
// ==========================================

// MLI Data extracted from report.html
const MLI_DATA = {
    fb_views: [
        {"Date": "2025-10-01", "Value": 55}, {"Date": "2025-10-02", "Value": 1}, {"Date": "2025-10-03", "Value": 5}, {"Date": "2025-10-04", "Value": 5}, {"Date": "2025-10-05", "Value": 2}, {"Date": "2025-10-06", "Value": 2}, {"Date": "2025-10-07", "Value": 0}, {"Date": "2025-10-08", "Value": 0}, {"Date": "2025-10-09", "Value": 0}, {"Date": "2025-10-10", "Value": 1}, {"Date": "2025-10-11", "Value": 3}, {"Date": "2025-10-12", "Value": 3}, {"Date": "2025-10-13", "Value": 2}, {"Date": "2025-10-14", "Value": 4}, {"Date": "2025-10-15", "Value": 2}, {"Date": "2025-10-16", "Value": 2}, {"Date": "2025-10-17", "Value": 7}, {"Date": "2025-10-18", "Value": 1}, {"Date": "2025-10-19", "Value": 8}, {"Date": "2025-10-20", "Value": 0}, {"Date": "2025-10-21", "Value": 1}, {"Date": "2025-10-22", "Value": 0}, {"Date": "2025-10-23", "Value": 1}, {"Date": "2025-10-24", "Value": 2}, {"Date": "2025-10-25", "Value": 0}, {"Date": "2025-10-26", "Value": 2}, {"Date": "2025-10-27", "Value": 0}, {"Date": "2025-10-28", "Value": 14}, {"Date": "2025-10-29", "Value": 6829}, {"Date": "2025-10-30", "Value": 21592}, {"Date": "2025-10-31", "Value": 10836}
    ],
    fb_visits: [
        {"Date": "2025-10-01", "Value": 3}, {"Date": "2025-10-02", "Value": 0}, {"Date": "2025-10-03", "Value": 0}, {"Date": "2025-10-04", "Value": 3}, {"Date": "2025-10-05", "Value": 0}, {"Date": "2025-10-06", "Value": 0}, {"Date": "2025-10-07", "Value": 0}, {"Date": "2025-10-08", "Value": 0}, {"Date": "2025-10-09", "Value": 0}, {"Date": "2025-10-10", "Value": 0}, {"Date": "2025-10-11", "Value": 0}, {"Date": "2025-10-12", "Value": 0}, {"Date": "2025-10-13", "Value": 0}, {"Date": "2025-10-14", "Value": 0}, {"Date": "2025-10-15", "Value": 0}, {"Date": "2025-10-16", "Value": 1}, {"Date": "2025-10-17", "Value": 6}, {"Date": "2025-10-18", "Value": 0}, {"Date": "2025-10-19", "Value": 1}, {"Date": "2025-10-20", "Value": 0}, {"Date": "2025-10-21", "Value": 0}, {"Date": "2025-10-22", "Value": 0}, {"Date": "2025-10-23", "Value": 0}, {"Date": "2025-10-24", "Value": 0}, {"Date": "2025-10-25", "Value": 0}, {"Date": "2025-10-26", "Value": 0}, {"Date": "2025-10-27", "Value": 1}, {"Date": "2025-10-28", "Value": 0}, {"Date": "2025-10-29", "Value": 3}, {"Date": "2025-10-30", "Value": 0}, {"Date": "2025-10-31", "Value": 3}
    ],
    fb_viewers: [
        {"Date": "2025-10-01", "Value": 50}, {"Date": "2025-10-02", "Value": 1}, {"Date": "2025-10-03", "Value": 4}, {"Date": "2025-10-04", "Value": 4}, {"Date": "2025-10-05", "Value": 1}, {"Date": "2025-10-06", "Value": 2}, {"Date": "2025-10-07", "Value": 0}, {"Date": "2025-10-08", "Value": 0}, {"Date": "2025-10-09", "Value": 0}, {"Date": "2025-10-10", "Value": 1}, {"Date": "2025-10-11", "Value": 2}, {"Date": "2025-10-12", "Value": 3}, {"Date": "2025-10-13", "Value": 2}, {"Date": "2025-10-14", "Value": 4}, {"Date": "2025-10-15", "Value": 1}, {"Date": "2025-10-16", "Value": 2}, {"Date": "2025-10-17", "Value": 1}, {"Date": "2025-10-18", "Value": 1}, {"Date": "2025-10-19", "Value": 5}, {"Date": "2025-10-20", "Value": 0}, {"Date": "2025-10-21", "Value": 1}, {"Date": "2025-10-22", "Value": 0}, {"Date": "2025-10-23", "Value": 1}, {"Date": "2025-10-24", "Value": 2}, {"Date": "2025-10-25", "Value": 0}, {"Date": "2025-10-26", "Value": 2}, {"Date": "2025-10-27", "Value": 0}, {"Date": "2025-10-28", "Value": 7}, {"Date": "2025-10-29", "Value": 3382}, {"Date": "2025-10-30", "Value": 9974}, {"Date": "2025-10-31", "Value": 4692}
    ],
    ig_reach: [
        {"Date": "2025-10-01", "Value": 55}, {"Date": "2025-10-02", "Value": 38}, {"Date": "2025-10-03", "Value": 37}, {"Date": "2025-10-04", "Value": 44}, {"Date": "2025-10-05", "Value": 255}, {"Date": "2025-10-06", "Value": 262}, {"Date": "2025-10-07", "Value": 86}, {"Date": "2025-10-08", "Value": 33}, {"Date": "2025-10-09", "Value": 45}, {"Date": "2025-10-10", "Value": 41}, {"Date": "2025-10-11", "Value": 31}, {"Date": "2025-10-12", "Value": 53}, {"Date": "2025-10-13", "Value": 26}, {"Date": "2025-10-14", "Value": 27}, {"Date": "2025-10-15", "Value": 26}, {"Date": "2025-10-16", "Value": 28}, {"Date": "2025-10-17", "Value": 25}, {"Date": "2025-10-18", "Value": 21}, {"Date": "2025-10-19", "Value": 277}, {"Date": "2025-10-20", "Value": 77}, {"Date": "2025-10-21", "Value": 417}, {"Date": "2025-10-22", "Value": 303}, {"Date": "2025-10-23", "Value": 142}, {"Date": "2025-10-24", "Value": 118}, {"Date": "2025-10-25", "Value": 58}, {"Date": "2025-10-26", "Value": 55}, {"Date": "2025-10-27", "Value": 26}, {"Date": "2025-10-28", "Value": 630}, {"Date": "2025-10-29", "Value": 3648}, {"Date": "2025-10-30", "Value": 10637}, {"Date": "2025-10-31", "Value": 9046}
    ],
    ig_interactions: [
        {"Date": "2025-10-01", "Value": 4}, {"Date": "2025-10-02", "Value": 7}, {"Date": "2025-10-03", "Value": 4}, {"Date": "2025-10-04", "Value": 2}, {"Date": "2025-10-05", "Value": 2}, {"Date": "2025-10-06", "Value": 6}, {"Date": "2025-10-07", "Value": 2}, {"Date": "2025-10-08", "Value": 2}, {"Date": "2025-10-09", "Value": 3}, {"Date": "2025-10-10", "Value": 4}, {"Date": "2025-10-11", "Value": 0}, {"Date": "2025-10-12", "Value": 6}, {"Date": "2025-10-13", "Value": 0}, {"Date": "2025-10-14", "Value": 1}, {"Date": "2025-10-15", "Value": 1}, {"Date": "2025-10-16", "Value": 0}, {"Date": "2025-10-17", "Value": 1}, {"Date": "2025-10-18", "Value": 1}, {"Date": "2025-10-19", "Value": 17}, {"Date": "2025-10-20", "Value": 0}, {"Date": "2025-10-21", "Value": 6}, {"Date": "2025-10-22", "Value": 3}, {"Date": "2025-10-23", "Value": 4}, {"Date": "2025-10-24", "Value": 2}, {"Date": "2025-10-25", "Value": 0}, {"Date": "2025-10-26", "Value": 0}, {"Date": "2025-10-27", "Value": 3}, {"Date": "2025-10-28", "Value": 42}, {"Date": "2025-10-29", "Value": 125}, {"Date": "2025-10-30", "Value": 195}, {"Date": "2025-10-31", "Value": 155}
    ],
    ig_views: [
        {"Date": "2025-10-01", "Value": 341}, {"Date": "2025-10-02", "Value": 470}, {"Date": "2025-10-03", "Value": 282}, {"Date": "2025-10-04", "Value": 375}, {"Date": "2025-10-05", "Value": 1286}, {"Date": "2025-10-06", "Value": 1360}, {"Date": "2025-10-07", "Value": 1154}, {"Date": "2025-10-08", "Value": 316}, {"Date": "2025-10-09", "Value": 674}, {"Date": "2025-10-10", "Value": 219}, {"Date": "2025-10-11", "Value": 308}, {"Date": "2025-10-12", "Value": 759}, {"Date": "2025-10-13", "Value": 167}, {"Date": "2025-10-14", "Value": 630}, {"Date": "2025-10-15", "Value": 566}, {"Date": "2025-10-16", "Value": 519}, {"Date": "2025-10-17", "Value": 415}, {"Date": "2025-10-18", "Value": 553}, {"Date": "2025-10-19", "Value": 2676}, {"Date": "2025-10-20", "Value": 625}, {"Date": "2025-10-21", "Value": 790}, {"Date": "2025-10-22", "Value": 916}, {"Date": "2025-10-23", "Value": 423}, {"Date": "2025-10-24", "Value": 642}, {"Date": "2025-10-25", "Value": 470}, {"Date": "2025-10-26", "Value": 248}, {"Date": "2025-10-27", "Value": 549}, {"Date": "2025-10-28", "Value": 1954}, {"Date": "2025-10-29", "Value": 6156}, {"Date": "2025-10-30", "Value": 19234}, {"Date": "2025-10-31", "Value": 17219}
    ],
    ig_follows: [
        {"Date": "2025-10-01", "Value": 6}, {"Date": "2025-10-02", "Value": 7}, {"Date": "2025-10-03", "Value": 3}, {"Date": "2025-10-04", "Value": 9}, {"Date": "2025-10-05", "Value": 7}, {"Date": "2025-10-06", "Value": 6}, {"Date": "2025-10-07", "Value": 5}, {"Date": "2025-10-08", "Value": 8}, {"Date": "2025-10-09", "Value": 9}, {"Date": "2025-10-10", "Value": 5}, {"Date": "2025-10-11", "Value": 8}, {"Date": "2025-10-12", "Value": 6}, {"Date": "2025-10-13", "Value": 8}, {"Date": "2025-10-14", "Value": 6}, {"Date": "2025-10-15", "Value": 5}, {"Date": "2025-10-16", "Value": 5}, {"Date": "2025-10-17", "Value": 7}, {"Date": "2025-10-18", "Value": 2}, {"Date": "2025-10-19", "Value": 8}, {"Date": "2025-10-20", "Value": 5}, {"Date": "2025-10-21", "Value": 6}, {"Date": "2025-10-22", "Value": 5}, {"Date": "2025-10-23", "Value": 5}, {"Date": "2025-10-24", "Value": 5}, {"Date": "2025-10-25", "Value": 8}, {"Date": "2025-10-26", "Value": 2}, {"Date": "2025-10-27", "Value": 7}, {"Date": "2025-10-28", "Value": 6}, {"Date": "2025-10-29", "Value": 9}, {"Date": "2025-10-30", "Value": 4}, {"Date": "2025-10-31", "Value": 5}
    ],
    ig_visits: [
        {"Date": "2025-10-01", "Value": 24}, {"Date": "2025-10-02", "Value": 23}, {"Date": "2025-10-03", "Value": 24}, {"Date": "2025-10-04", "Value": 24}, {"Date": "2025-10-05", "Value": 28}, {"Date": "2025-10-06", "Value": 40}, {"Date": "2025-10-07", "Value": 31}, {"Date": "2025-10-08", "Value": 22}, {"Date": "2025-10-09", "Value": 34}, {"Date": "2025-10-10", "Value": 31}, {"Date": "2025-10-11", "Value": 25}, {"Date": "2025-10-12", "Value": 52}, {"Date": "2025-10-13", "Value": 22}, {"Date": "2025-10-14", "Value": 30}, {"Date": "2025-10-15", "Value": 43}, {"Date": "2025-10-16", "Value": 61}, {"Date": "2025-10-17", "Value": 44}, {"Date": "2025-10-18", "Value": 49}, {"Date": "2025-10-19", "Value": 92}, {"Date": "2025-10-20", "Value": 43}, {"Date": "2025-10-21", "Value": 28}, {"Date": "2025-10-22", "Value": 38}, {"Date": "2025-10-23", "Value": 28}, {"Date": "2025-10-24", "Value": 30}, {"Date": "2025-10-25", "Value": 32}, {"Date": "2025-10-26", "Value": 20}, {"Date": "2025-10-27", "Value": 29}, {"Date": "2025-10-28", "Value": 58}, {"Date": "2025-10-29", "Value": 31}, {"Date": "2025-10-30", "Value": 38}, {"Date": "2025-10-31", "Value": 44}
    ]
};

// MLI KPIs calculated from data
const MLI_KPIS = {
    fb_views: {
        total: 39380,
        average: 1270.32,
        max: 21592,
        min: 0,
        latest: 10836,
        last7Days: 39273,
        growth: 302000.00
    },
    fb_visits: {
        total: 21,
        average: 0.68,
        max: 6,
        min: 0,
        latest: 3,
        last7Days: 7,
        growth: 600.00
    },
    fb_viewers: {
        total: 18145,
        average: 585.32,
        max: 9974,
        min: 0,
        latest: 4692,
        last7Days: 18057,
        growth: 180470.00
    },
    ig_reach: {
        total: 26567,
        average: 857.00,
        max: 10637,
        min: 21,
        latest: 9046,
        last7Days: 24100,
        growth: 1678.60
    },
    ig_interactions: {
        total: 598,
        average: 19.29,
        max: 195,
        min: 0,
        latest: 155,
        last7Days: 520,
        growth: 1475.76
    },
    ig_views: {
        total: 62296,
        average: 2009.55,
        max: 19234,
        min: 167,
        latest: 17219,
        last7Days: 45830,
        growth: 591.77
    },
    ig_follows: {
        total: 187,
        average: 6.03,
        max: 9,
        min: 2,
        latest: 5,
        last7Days: 41,
        growth: 13.89
    },
    ig_visits: {
        total: 1118,
        average: 36.06,
        max: 92,
        min: 20,
        latest: 44,
        last7Days: 252,
        growth: -18.18
    }
};

// Top performing days
const MLI_TOP_DAYS = {
    fb_views: [
        {"Date": "2025-10-30", "Value": 21592},
        {"Date": "2025-10-31", "Value": 10836},
        {"Date": "2025-10-29", "Value": 6829},
        {"Date": "2025-10-01", "Value": 55},
        {"Date": "2025-10-28", "Value": 14}
    ],
    ig_views: [
        {"Date": "2025-10-30", "Value": 19234},
        {"Date": "2025-10-31", "Value": 17219},
        {"Date": "2025-10-29", "Value": 6156},
        {"Date": "2025-10-19", "Value": 2676},
        {"Date": "2025-10-28", "Value": 1954}
    ],
    ig_reach: [
        {"Date": "2025-10-30", "Value": 10637},
        {"Date": "2025-10-31", "Value": 9046},
        {"Date": "2025-10-29", "Value": 3648},
        {"Date": "2025-10-28", "Value": 630},
        {"Date": "2025-10-21", "Value": 417}
    ],
    ig_interactions: [
        {"Date": "2025-10-30", "Value": 195},
        {"Date": "2025-10-31", "Value": 155},
        {"Date": "2025-10-29", "Value": 125},
        {"Date": "2025-10-28", "Value": 42},
        {"Date": "2025-10-19", "Value": 17}
    ]
};

const MLI_ALL_DATES = Object.values(MLI_DATA).flatMap(series => series.map(point => point.Date));
const MLI_EARLIEST_DATE = MLI_ALL_DATES.length
    ? new Date(Math.min(...MLI_ALL_DATES.map(date => Date.parse(date))))
    : new Date();
const MLI_LATEST_DATE = MLI_ALL_DATES.length
    ? new Date(Math.max(...MLI_ALL_DATES.map(date => Date.parse(date))))
    : new Date();

const MLI_SERIES_MAPS = Object.fromEntries(
    Object.entries(MLI_DATA).map(([key, series]) => [
        key,
        series.reduce((map, point) => {
            const normalized = point.Date;
            map[normalized] = Number(point.Value) || 0;
            return map;
        }, {})
    ])
);

const MLI_TREND_SERIES = [
    { key: 'fb_views', label: 'FB Views' },
    { key: 'fb_visits', label: 'FB Visits' },
    { key: 'fb_viewers', label: 'FB Viewers' },
    { key: 'ig_reach', label: 'IG Reach' },
    { key: 'ig_interactions', label: 'IG Interactions' },
    { key: 'ig_views', label: 'IG Views' }
];

const MLI_TREND_COLORS = {
    fb_views: { stroke: '#0f172a', fill: 'rgba(15, 23, 42, 0.12)' },
    fb_visits: { stroke: '#1e293b', fill: 'rgba(30, 41, 59, 0.12)' },
    fb_viewers: { stroke: '#334155', fill: 'rgba(51, 65, 85, 0.12)' },
    ig_reach: { stroke: '#475569', fill: 'rgba(71, 85, 105, 0.12)' },
    ig_interactions: { stroke: '#64748b', fill: 'rgba(100, 116, 139, 0.12)' },
    ig_views: { stroke: '#94a3b8', fill: 'rgba(148, 163, 184, 0.18)' }
};

function formatMLIDisplayDate(date) {
    return date.toLocaleDateString('en-US', {
        month: 'short',
        day: 'numeric',
        year: 'numeric'
    });
}

function formatMLIISODate(date) {
    return date.toISOString().split('T')[0];
}

function parseMLIDate(value) {
    if (!value) return null;
    const parts = value.split('-').map(Number);
    if (parts.length !== 3 || parts.some(Number.isNaN)) {
        return null;
    }
    return new Date(parts[0], parts[1] - 1, parts[2]);
}

function buildDateSequence(range) {
    const start = parseMLIDate(range.from);
    const end = parseMLIDate(range.to);
    if (!start || !end || start > end) {
        return [];
    }

    const dates = [];
    const cursor = new Date(start);
    while (cursor <= end) {
        dates.push(new Date(cursor));
        cursor.setDate(cursor.getDate() + 1);
    }
    return dates;
}

function createChartDataset(label, seriesKey, isoDates, displayColor) {
    const map = MLI_SERIES_MAPS[seriesKey] || {};
    return {
        label,
        data: isoDates.map(date => map[date] ?? 0),
        borderColor: displayColor.stroke,
        borderWidth: 2,
        backgroundColor: displayColor.fill,
        tension: 0.25,
        pointRadius: 0
    };
}

// ==========================================
// MLI Dashboard Functions
// ==========================================

const mliTrendCharts = {};

function formatMLINumber(value) {
    if (value === null || value === undefined || isNaN(value)) {
        return '—';
    }
    const absValue = Math.abs(value);
    if (absValue >= 1000000) {
        return (value / 1000000).toFixed(1).replace(/\.0$/, '') + 'M';
    }
    if (absValue >= 1000) {
        return (value / 1000).toFixed(1).replace(/\.0$/, '') + 'K';
    }
    return new Intl.NumberFormat().format(Math.round(value));
}

function getMLIDataRange(rangeKey) {
    const RANGE_MONTHS = {
        '3_months': 3,
        '6_months': 6,
        '12_months': 12
    };

    const key = RANGE_MONTHS[rangeKey] ? rangeKey : '3_months';
    const months = RANGE_MONTHS[key];
    const toDate = new Date(MLI_LATEST_DATE);
    const candidateFrom = new Date(toDate);
    candidateFrom.setMonth(candidateFrom.getMonth() - months + 1);
    candidateFrom.setDate(1);

    const earliest = new Date(MLI_EARLIEST_DATE);
    const fromDate = candidateFrom < earliest ? earliest : candidateFrom;

    const labelMap = {
        '3_months': 'Last 3 Months',
        '6_months': 'Last 6 Months',
        '12_months': 'Last 12 Months'
    };

    return {
        key,
        label: labelMap[key],
        summary: `${formatMLIDisplayDate(fromDate)} \u2192 ${formatMLIDisplayDate(toDate)}`,
        from: formatMLIISODate(fromDate),
        to: formatMLIISODate(toDate)
    };
}

function filterMLIDataByRange(data, range) {
    if (!data || !range) return [];
    
    const fromTime = Date.parse(range.from);
    const toTime = Date.parse(range.to);
    
    return data.filter(point => {
        const pointTime = Date.parse(point.Date);
        return pointTime >= fromTime && pointTime <= toTime;
    });
}

function calculateMLIKPIs(data, range) {
    const filteredData = filterMLIDataByRange(data, range);
    if (filteredData.length === 0) {
        return {
            total: 0,
            average: 0,
            max: 0,
            min: 0,
            latest: 0
        };
    }
    
    const values = filteredData.map(d => d.Value);
    const total = values.reduce((sum, val) => sum + val, 0);
    const average = total / values.length;
    const max = Math.max(...values);
    const min = Math.min(...values);
    const latest = values[values.length - 1];
    
    return {
        total: Math.round(total),
        average: Math.round(average * 100) / 100,
        max,
        min,
        latest
    };
}

function updateMLIMetrics(range) {
    // Update key metrics cards
    const fbViewsKPI = calculateMLIKPIs(MLI_DATA.fb_views, range);
    const igReachKPI = calculateMLIKPIs(MLI_DATA.ig_reach, range);
    const igInteractionsKPI = calculateMLIKPIs(MLI_DATA.ig_interactions, range);
    const igViewsKPI = calculateMLIKPIs(MLI_DATA.ig_views, range);
    
    document.getElementById('mli-fb-views').textContent = formatMLINumber(fbViewsKPI.latest);
    document.getElementById('mli-ig-reach').textContent = formatMLINumber(igReachKPI.latest);
    document.getElementById('mli-ig-interactions').textContent = formatMLINumber(igInteractionsKPI.latest);
    document.getElementById('mli-ig-views').textContent = formatMLINumber(igViewsKPI.latest);
    
    // Update Facebook table
    updateMLIFacebookTable(range);
    
    // Update Instagram table
    updateMLIInstagramTable(range);
    
    // Update top performing days
    updateMLITopDays(range);
    
    // Update trend charts
    updateMLITrendCharts(range);

    const caption = document.getElementById('mli-chart-caption');
    if (caption) {
        caption.textContent = `Channel performance snapshots · ${range.summary}`;
    }
}

function updateMLIFacebookTable(range) {
    const tableBody = document.getElementById('mli-fb-table');
    if (!tableBody) return;
    
    const fbViewsKPI = calculateMLIKPIs(MLI_DATA.fb_views, range);
    const fbVisitsKPI = calculateMLIKPIs(MLI_DATA.fb_visits, range);
    const fbViewersKPI = calculateMLIKPIs(MLI_DATA.fb_viewers, range);
    
    tableBody.innerHTML = `
        <tr>
            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">FB Views</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${formatMLINumber(fbViewsKPI.total)}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${formatMLINumber(fbViewsKPI.average)}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm font-semibold text-slate-800">${formatMLINumber(fbViewsKPI.latest)}</td>
        </tr>
        <tr>
            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">FB Visits</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${formatMLINumber(fbVisitsKPI.total)}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${formatMLINumber(fbVisitsKPI.average)}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm font-semibold text-slate-800">${formatMLINumber(fbVisitsKPI.latest)}</td>
        </tr>
        <tr>
            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">FB Viewers</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${formatMLINumber(fbViewersKPI.total)}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${formatMLINumber(fbViewersKPI.average)}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm font-semibold text-slate-800">${formatMLINumber(fbViewersKPI.latest)}</td>
        </tr>
    `;
}

function updateMLIInstagramTable(range) {
    const tableBody = document.getElementById('mli-ig-table');
    if (!tableBody) return;
    
    const igReachKPI = calculateMLIKPIs(MLI_DATA.ig_reach, range);
    const igInteractionsKPI = calculateMLIKPIs(MLI_DATA.ig_interactions, range);
    const igViewsKPI = calculateMLIKPIs(MLI_DATA.ig_views, range);
    const igFollowsKPI = calculateMLIKPIs(MLI_DATA.ig_follows, range);
    const igVisitsKPI = calculateMLIKPIs(MLI_DATA.ig_visits, range);
    
    tableBody.innerHTML = `
        <tr>
            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">IG Reach</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${formatMLINumber(igReachKPI.total)}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${formatMLINumber(igReachKPI.average)}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm font-semibold text-slate-800">${formatMLINumber(igReachKPI.latest)}</td>
        </tr>
        <tr>
            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">IG Interactions</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${formatMLINumber(igInteractionsKPI.total)}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${formatMLINumber(igInteractionsKPI.average)}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm font-semibold text-slate-800">${formatMLINumber(igInteractionsKPI.latest)}</td>
        </tr>
        <tr>
            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">IG Views</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${formatMLINumber(igViewsKPI.total)}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${formatMLINumber(igViewsKPI.average)}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm font-semibold text-slate-800">${formatMLINumber(igViewsKPI.latest)}</td>
        </tr>
        <tr>
            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">IG Follows</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${formatMLINumber(igFollowsKPI.total)}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${formatMLINumber(igFollowsKPI.average)}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm font-semibold text-slate-800">${formatMLINumber(igFollowsKPI.latest)}</td>
        </tr>
        <tr>
            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">IG Visits</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${formatMLINumber(igVisitsKPI.total)}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${formatMLINumber(igVisitsKPI.average)}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm font-semibold text-slate-800">${formatMLINumber(igVisitsKPI.latest)}</td>
        </tr>
    `;
}

function updateMLITopDays(range) {
    const container = document.getElementById('mli-top-days');
    if (!container) return;
    
    const fbViewsTop = filterMLIDataByRange(MLI_TOP_DAYS.fb_views, range);
    const igViewsTop = filterMLIDataByRange(MLI_TOP_DAYS.ig_views, range);
    const igReachTop = filterMLIDataByRange(MLI_TOP_DAYS.ig_reach, range);
    const igInteractionsTop = filterMLIDataByRange(MLI_TOP_DAYS.ig_interactions, range);
    
    container.innerHTML = `
        <div class="dashboard-card p-4">
            <h4 class="text-sm font-semibold text-gray-900 mb-3">FB Views</h4>
            <div class="space-y-2">
                ${fbViewsTop.slice(0, 3).map((item, index) => `
                    <div class="flex justify-between items-center">
                        <span class="text-sm text-gray-600">${item.Date}</span>
                        <span class="text-sm font-semibold text-slate-800">${formatMLINumber(item.Value)}</span>
                    </div>
                `).join('')}
            </div>
        </div>
        <div class="dashboard-card p-4">
            <h4 class="text-sm font-semibold text-gray-900 mb-3">IG Views</h4>
            <div class="space-y-2">
                ${igViewsTop.slice(0, 3).map((item, index) => `
                    <div class="flex justify-between items-center">
                        <span class="text-sm text-gray-600">${item.Date}</span>
                        <span class="text-sm font-semibold text-slate-800">${formatMLINumber(item.Value)}</span>
                    </div>
                `).join('')}
            </div>
        </div>
        <div class="dashboard-card p-4">
            <h4 class="text-sm font-semibold text-gray-900 mb-3">IG Interactions</h4>
            <div class="space-y-2">
                ${igInteractionsTop.slice(0, 3).map((item, index) => `
                    <div class="flex justify-between items-center">
                        <span class="text-sm text-gray-600">${item.Date}</span>
                        <span class="text-sm font-semibold text-slate-800">${formatMLINumber(item.Value)}</span>
                    </div>
                `).join('')}
            </div>
        </div>
    `;
}

function destroyMLITrendCharts() {
    Object.keys(mliTrendCharts).forEach(key => {
        if (mliTrendCharts[key]) {
            mliTrendCharts[key].destroy();
        }
        delete mliTrendCharts[key];
    });
}

function updateMLITrendCharts(range) {
    const dateSequence = buildDateSequence(range);
    if (!dateSequence.length) {
        destroyMLITrendCharts();
        return;
    }

    const isoDates = dateSequence.map(date => formatMLIISODate(date));
    const labels = dateSequence.map(date =>
        date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })
    );
    const labelInterval = Math.max(1, Math.floor(labels.length / 4));

    MLI_TREND_SERIES.forEach(series => {
        const canvas = document.getElementById(`mliTrend-${series.key}`);
        if (!canvas) return;

        if (mliTrendCharts[series.key]) {
            mliTrendCharts[series.key].destroy();
        }

        const color = MLI_TREND_COLORS[series.key];
        const dataset = createChartDataset(series.label, series.key, isoDates, color);

        mliTrendCharts[series.key] = new Chart(canvas, {
            type: 'line',
            data: {
                labels,
                datasets: [dataset]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        mode: 'index',
                        intersect: false,
                        backgroundColor: '#0f172a',
                        titleColor: '#f8fafc',
                        bodyColor: '#f8fafc',
                        borderWidth: 0
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        grid: {
                            color: 'rgba(148, 163, 184, 0.2)'
                        },
                        ticks: {
                            color: '#475569',
                            callback: function(value) {
                                return formatMLINumber(value);
                            }
                        }
                    },
                    x: {
                        grid: {
                            display: false
                        },
                        ticks: {
                            color: '#475569',
                            maxRotation: 0,
                            callback: function(value, index) {
                                if (index === 0 || index === labels.length - 1) {
                                    return labels[index];
                                }
                                return index % labelInterval === 0 ? labels[index] : '';
                            }
                        }
                    }
                }
            }
        });
    });
}

async function loadMLIData(forceRefresh = false) {
    if (state.currentProject !== 'mli' || state.currentLocation !== 'marketing') {
        return;
    }
    const rangeKey = state.mliRange || '3_months';
    const range = getMLIDataRange(rangeKey);
    
    try {
        showLoading();
        
        // Update range summary
        const rangeSummaryElement = document.getElementById('mli-range-summary');
        if (rangeSummaryElement) {
            rangeSummaryElement.textContent = `${range.label} · ${range.summary}`;
        }
        
        // Update all metrics
        updateMLIMetrics(range);
        
        updateLastUpdated();
    } catch (error) {
        console.error('Failed to load MLI data:', error);
        showError('Failed to load MLI data. Please try again.');
    } finally {
        hideLoading();
    }
}
