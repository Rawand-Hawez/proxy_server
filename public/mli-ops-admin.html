<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MLI Operations Programs</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Arial, sans-serif;
      background: linear-gradient(135deg, #4b79a1 0%, #283e51 100%);
      min-height: 100vh;
      padding: 24px;
      color: #1f2933;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      background: #ffffff;
      border-radius: 16px;
      box-shadow: 0 30px 60px rgba(0, 0, 0, 0.15);
      overflow: hidden;
    }

    .header {
      background: #1f2933;
      color: #ffffff;
      padding: 32px;
    }

    .header h1 {
      font-size: 2.5rem;
      margin-bottom: 8px;
      font-weight: 600;
    }

    .header p {
      opacity: 0.8;
      font-size: 1rem;
    }

    .actions {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      margin-top: 24px;
    }

    .btn {
      border: none;
      border-radius: 8px;
      padding: 12px 20px;
      font-size: 0.95rem;
      cursor: pointer;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(0, 0, 0, 0.15);
    }

    .btn-primary {
      background: #2563eb;
      color: #ffffff;
    }

    .btn-danger {
      background: #dc2626;
      color: #ffffff;
    }

    .content {
      padding: 32px;
    }

    .stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 32px;
    }

    .stat-card {
      padding: 20px;
      border-radius: 12px;
      background: #f8fafc;
      border: 1px solid #e2e8f0;
      text-align: center;
    }

    .stat-card h3 {
      font-size: 0.85rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: #64748b;
      margin-bottom: 10px;
    }

    .stat-card .value {
      font-size: 2rem;
      font-weight: 600;
      color: #111827;
    }

    .table-container {
      overflow-x: auto;
      border-radius: 12px;
      box-shadow: 0 12px 30px rgba(0, 0, 0, 0.08);
    }

    table {
      width: 100%;
      border-collapse: collapse;
      min-width: 800px;
    }

    th, td {
      padding: 16px;
      text-align: left;
      border-bottom: 1px solid #e5e7eb;
    }

    th {
      background: #f1f5f9;
      font-weight: 600;
      color: #1f2937;
    }

    tr:hover td {
      background: #f9fafb;
    }

    .status-badge {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 999px;
      font-size: 0.8rem;
      font-weight: 600;
      text-transform: capitalize;
    }

    .status-completed {
      background: #dcfce7;
      color: #166534;
    }

    .status-planned {
      background: #ede9fe;
      color: #5b21b6;
    }

    .modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(15, 23, 42, 0.65);
      display: none;
      align-items: center;
      justify-content: center;
      padding: 24px;
      z-index: 1000;
    }

    .modal-content {
      background: #ffffff;
      border-radius: 16px;
      width: 100%;
      max-width: 900px;
      padding: 32px;
      max-height: 95vh;
      overflow-y: auto;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 24px;
    }

    .modal-header h2 {
      font-size: 1.5rem;
    }

    .modal-header button {
      background: transparent;
      border: none;
      font-size: 1.5rem;
      cursor: pointer;
    }

    .form-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 20px;
    }

    .form-group {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .form-group label {
      font-size: 0.9rem;
      color: #475569;
    }

    .form-group input,
    .form-group select,
    .form-group textarea {
      padding: 10px 12px;
      border-radius: 8px;
      border: 1px solid #cbd5f5;
      font-size: 0.95rem;
    }

    textarea {
      resize: vertical;
      min-height: 100px;
    }

    .form-actions {
      margin-top: 24px;
      display: flex;
      justify-content: flex-end;
      gap: 12px;
    }

    .toast {
      position: fixed;
      bottom: 24px;
      right: 24px;
      background: #111827;
      color: #ffffff;
      padding: 12px 20px;
      border-radius: 999px;
      box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
      animation: fadeIn 0.3s ease;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    @media (max-width: 768px) {
      .form-grid {
        grid-template-columns: 1fr;
      }

      th, td {
        padding: 12px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>MLI Operations Programs</h1>
      <p>Manage program data, track revenue, and keep operational metrics up to date.</p>
      <div class="actions">
        <button class="btn btn-primary" id="addProgramBtn">Add Program</button>
        <button class="btn btn-danger" id="clearProgramsBtn">Clear All</button>
      </div>
    </div>

    <div class="content">
      <div class="stats">
        <div class="stat-card">
          <h3>Total Programs</h3>
          <div class="value" id="statTotal">0</div>
        </div>
        <div class="stat-card">
          <h3>Completed</h3>
          <div class="value" id="statCompleted">0</div>
        </div>
        <div class="stat-card">
          <h3>Planned</h3>
          <div class="value" id="statPlanned">0</div>
        </div>
        <div class="stat-card">
          <h3>Total Revenue</h3>
          <div class="value" id="statRevenue">$0</div>
        </div>
      </div>

      <div class="table-container">
        <table>
          <thead>
            <tr>
              <th>Program</th>
              <th>Status</th>
              <th>Participants</th>
              <th>Trainers</th>
              <th>Start Date</th>
              <th>End Date</th>
              <th>Participant Fee</th>
              <th>Program Cost</th>
              <th>Revenue</th>
              <th></th>
            </tr>
          </thead>
          <tbody id="programRows"></tbody>
        </table>
      </div>
    </div>
  </div>

  <div class="modal" id="programModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 id="modalTitle">Add Program</h2>
        <button type="button" id="closeModal">Ã—</button>
      </div>
      <form id="programForm">
        <input type="hidden" id="formProgramId">
        <div class="form-grid">
          <div class="form-group">
            <label for="formProgram">Program Name *</label>
            <input type="text" id="formProgram" required>
          </div>
          <div class="form-group">
            <label for="formParticipants">Number of Participants</label>
            <input type="number" id="formParticipants" min="0">
          </div>
          <div class="form-group">
            <label for="formMale">Male Participants</label>
            <input type="number" id="formMale" min="0">
          </div>
          <div class="form-group">
            <label for="formFemale">Female Participants</label>
            <input type="number" id="formFemale" min="0">
          </div>
          <div class="form-group">
            <label for="formLocalTrainer">Local Trainers</label>
            <input type="number" id="formLocalTrainer" min="0">
          </div>
          <div class="form-group">
            <label for="formExpatTrainer">Expat Trainers</label>
            <input type="number" id="formExpatTrainer" min="0">
          </div>
          <div class="form-group">
            <label for="formDuration">Duration (days)</label>
            <input type="number" id="formDuration" min="0">
          </div>
          <div class="form-group">
            <label for="formStartDate">Start Date</label>
            <input type="date" id="formStartDate">
          </div>
          <div class="form-group">
            <label for="formEndDate">End Date</label>
            <input type="date" id="formEndDate">
          </div>
          <div class="form-group">
            <label for="formStatus">Status</label>
            <select id="formStatus">
              <option value="auto">Auto</option>
              <option value="planned">Planned</option>
              <option value="completed">Completed</option>
            </select>
          </div>
          <div class="form-group">
            <label for="formParticipantFee">Participant Fee ($)</label>
            <input type="number" step="0.01" id="formParticipantFee" min="0">
          </div>
          <div class="form-group">
            <label for="formActualRevenue">Actual Revenue ($)</label>
            <input type="number" step="0.01" id="formActualRevenue" min="0">
          </div>
          <div class="form-group">
            <label for="formNonMonetaryRevenue">Non-Monetary Revenue ($)</label>
            <input type="number" step="0.01" id="formNonMonetaryRevenue" min="0">
          </div>
          <div class="form-group">
            <label for="formTotalRevenue">Total Revenue Override ($)</label>
            <input type="number" step="0.01" id="formTotalRevenue" min="0">
          </div>
          <div class="form-group">
            <label for="formProgramCost">Program Cost ($)</label>
            <input type="number" step="0.01" id="formProgramCost" min="0">
          </div>
          <div class="form-group" style="grid-column: span 2;">
            <label for="formNotes">Notes</label>
            <textarea id="formNotes" placeholder="Optional notes..."></textarea>
          </div>
        </div>
        <div class="form-actions">
          <button type="button" class="btn btn-danger" id="deleteProgramBtn" style="display:none;">Delete</button>
          <button type="submit" class="btn btn-primary">Save Program</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    const programRows = document.getElementById('programRows');
    const programModal = document.getElementById('programModal');
    const form = document.getElementById('programForm');
    const deleteBtn = document.getElementById('deleteProgramBtn');
    const modalTitle = document.getElementById('modalTitle');

    let programs = [];

    const currency = new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' });

    function formatProgram(program) {
      const local = Number(program.local_trainer) || 0;
      const expat = Number(program.expat_trainer) || 0;
      const participants = Number(program.number_of_participants) || 0;
      const participantFee = Number(program.participant_fee) || 0;
      const computedRevenue = participants && participantFee ? participants * participantFee : null;
      const override = program.total_revenue_input !== null && program.total_revenue_input !== undefined
        ? Number(program.total_revenue_input)
        : null;
      const finalRevenue = override !== null ? override : computedRevenue;
      const status = program.status || (participants > 0 ? 'completed' : 'planned');

      return {
        ...program,
        status,
        trainers: local + expat,
        computedRevenue,
        finalRevenue,
        revenueOverridden: override !== null && computedRevenue !== null && Math.abs(override - computedRevenue) > 0.01
      };
    }

    async function fetchPrograms() {
      const response = await fetch('/api/mli-ops/programs');
      const result = await response.json();
      if (!response.ok || !result.success) {
        throw new Error(result.error || 'Failed to load programs');
      }
      return result.data.map(formatProgram);
    }

    async function saveProgramRequest(payload) {
      const hasId = Boolean(payload.id);
      const url = hasId ? `/api/mli-ops/programs/${payload.id}` : '/api/mli-ops/programs';
      const method = hasId ? 'PUT' : 'POST';
      const response = await fetch(url, {
        method,
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });
      const result = await response.json();
      if (!response.ok || !result.success) {
        throw new Error(result.error || 'Failed to save program');
      }
      return formatProgram(result.data);
    }

    async function deleteProgram(id) {
      const response = await fetch(`/api/mli-ops/programs/${id}`, { method: 'DELETE' });
      const result = await response.json();
      if (!response.ok || !result.success) {
        throw new Error(result.error || 'Failed to delete program');
      }
    }

    async function clearPrograms() {
      const response = await fetch('/api/mli-ops/programs', { method: 'DELETE' });
      const result = await response.json();
      if (!response.ok || !result.success) {
        throw new Error(result.error || 'Failed to clear programs');
      }
    }

    function renderPrograms() {
      document.getElementById('statTotal').textContent = programs.length;
      document.getElementById('statCompleted').textContent = programs.filter(p => p.status === 'completed').length;
      document.getElementById('statPlanned').textContent = programs.filter(p => p.status === 'planned').length;
      const totalRevenue = programs
        .filter(p => p.status === 'completed')
        .reduce((sum, program) => sum + (program.finalRevenue || 0), 0);
      document.getElementById('statRevenue').textContent = currency.format(totalRevenue || 0);

      programRows.innerHTML = programs.map(program => `
        <tr>
          <td>
            <strong>${program.program}</strong>
            ${program.notes ? `<div style="color:#64748b;font-size:0.85rem;margin-top:4px;">${program.notes}</div>` : ''}
          </td>
          <td><span class="status-badge status-${program.status}">${program.status}</span></td>
          <td>${program.number_of_participants || ''}</td>
          <td>${program.trainers || ''}</td>
          <td>${program.start_date || ''}</td>
          <td>${program.end_date || ''}</td>
          <td>${program.participant_fee ? currency.format(program.participant_fee) : ''}</td>
          <td>${program.program_cost ? currency.format(program.program_cost) : ''}</td>
          <td>${program.finalRevenue ? currency.format(program.finalRevenue) : ''}</td>
          <td>
            <button class="btn btn-primary" data-action="edit" data-id="${program.id}">Edit</button>
          </td>
        </tr>
      `).join('');
    }

    function openModal(program = null) {
      if (program) {
        modalTitle.textContent = 'Edit Program';
        document.getElementById('formProgramId').value = program.id;
        document.getElementById('formProgram').value = program.program || '';
        document.getElementById('formParticipants').value = program.number_of_participants || '';
        document.getElementById('formMale').value = program.male || '';
        document.getElementById('formFemale').value = program.female || '';
        document.getElementById('formLocalTrainer').value = program.local_trainer || '';
        document.getElementById('formExpatTrainer').value = program.expat_trainer || '';
        document.getElementById('formDuration').value = program.duration_days || '';
        document.getElementById('formStartDate').value = program.start_date || '';
        document.getElementById('formEndDate').value = program.end_date || '';
        document.getElementById('formStatus').value = program.status || 'auto';
        document.getElementById('formParticipantFee').value = program.participant_fee || '';
        document.getElementById('formActualRevenue').value = program.actual_revenue || '';
        document.getElementById('formNonMonetaryRevenue').value = program.non_monetary_revenue || '';
        document.getElementById('formTotalRevenue').value = program.total_revenue_input || '';
        document.getElementById('formProgramCost').value = program.program_cost || '';
        document.getElementById('formNotes').value = program.notes || '';
        deleteBtn.style.display = 'inline-flex';
      } else {
        modalTitle.textContent = 'Add Program';
        form.reset();
        document.getElementById('formProgramId').value = '';
        deleteBtn.style.display = 'none';
      }
      programModal.style.display = 'flex';
    }

    function closeModal() {
      programModal.style.display = 'none';
    }

    function collectFormData() {
      const parseNumber = (value) => {
        if (value === '' || value === null || value === undefined) return null;
        const num = Number(value);
        return Number.isNaN(num) ? null : num;
      };

      return {
        id: document.getElementById('formProgramId').value || undefined,
        program: document.getElementById('formProgram').value,
        number_of_participants: parseNumber(document.getElementById('formParticipants').value),
        male: parseNumber(document.getElementById('formMale').value),
        female: parseNumber(document.getElementById('formFemale').value),
        local_trainer: parseNumber(document.getElementById('formLocalTrainer').value),
        expat_trainer: parseNumber(document.getElementById('formExpatTrainer').value),
        duration_days: parseNumber(document.getElementById('formDuration').value),
        start_date: document.getElementById('formStartDate').value || null,
        end_date: document.getElementById('formEndDate').value || null,
        status: document.getElementById('formStatus').value,
        participant_fee: parseNumber(document.getElementById('formParticipantFee').value),
        actual_revenue: parseNumber(document.getElementById('formActualRevenue').value),
        non_monetary_revenue: parseNumber(document.getElementById('formNonMonetaryRevenue').value),
        total_revenue_input: parseNumber(document.getElementById('formTotalRevenue').value),
        program_cost: parseNumber(document.getElementById('formProgramCost').value),
        notes: document.getElementById('formNotes').value || null
      };
    }

    function showToast(message) {
      const toast = document.createElement('div');
      toast.className = 'toast';
      toast.textContent = message;
      document.body.appendChild(toast);
      setTimeout(() => toast.remove(), 3000);
    }

    // Event bindings
    document.addEventListener('DOMContentLoaded', async () => {
      try {
        programs = await fetchPrograms();
        renderPrograms();
      } catch (error) {
        console.error(error);
        showToast(error.message || 'Failed to load programs');
      }
    });

    document.getElementById('addProgramBtn').addEventListener('click', () => openModal());
    document.getElementById('clearProgramsBtn').addEventListener('click', async () => {
      if (!confirm('This will delete all programs. Continue?')) return;
      try {
        await clearPrograms();
        programs = [];
        renderPrograms();
        showToast('All programs cleared');
      } catch (error) {
        console.error(error);
        showToast(error.message || 'Unable to clear programs');
      }
    });

    programRows.addEventListener('click', (event) => {
      const button = event.target.closest('button[data-action="edit"]');
      if (!button) return;
      const id = Number(button.dataset.id);
      const program = programs.find(item => item.id === id);
      if (program) {
        openModal(program);
      }
    });

    document.getElementById('closeModal').addEventListener('click', closeModal);
    programModal.addEventListener('click', (event) => {
      if (event.target === programModal) {
        closeModal();
      }
    });

    form.addEventListener('submit', async (event) => {
      event.preventDefault();
      const payload = collectFormData();
      try {
        const saved = await saveProgramRequest(payload);
        const index = programs.findIndex(p => p.id === saved.id);
        if (index >= 0) {
          programs[index] = saved;
        } else {
          programs.push(saved);
        }
        programs = programs.map(formatProgram);
        renderPrograms();
        closeModal();
        showToast('Program saved successfully');
      } catch (error) {
        console.error(error);
        showToast(error.message || 'Failed to save program');
      }
    });

    deleteBtn.addEventListener('click', async () => {
      const id = document.getElementById('formProgramId').value;
      if (!id) return;
      if (!confirm('Delete this program?')) return;

      try {
        await deleteProgram(id);
        programs = programs.filter(program => String(program.id) !== String(id));
        renderPrograms();
        closeModal();
        showToast('Program deleted successfully');
      } catch (error) {
        console.error(error);
        showToast(error.message || 'Failed to delete program');
      }
    });
  </script>
</body>
</html>
